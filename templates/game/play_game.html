{% extends "layout.html" %}
{% block title %}Game{% endblock %}
{% block content_header %}Mastermind{% endblock %}
{% block content %}
    <div class="game-flex">
        <div class="container">
            <div class="game nes-container with-title">
                <h2 class="title">Game</h2>
                {% if game.completed %}
                    <h1>Victory</h1>
                    <i class="nes-icon trophy is-large"></i>
                    <div class="nes-container with-title is-centered">
                        <p class="title">Stats</p>
                        <ul class="victory-stats">
                            <li>Turns Until Victory: {{ game.current_turn }}</li>
                            <li>Amount of Positions Played: {{ game.amount_of_positions }}</li>
                            <li>Code: {{ game.code }}</li>
                        </ul>
                    </div>
                    <div id="victory-buttons">
                        <a class="nes-btn" href="{{ url_for('game.index') }}">Back</a>
                        <a class="nes-btn is-primary" href="{{ url_for('game.get_game_info', game_id=game.id) }}">Show
                            advanced
                            stats</a>
                    </div>
                {% else %}
                    <form id="play-game-form" method="POST" action="{{ url_for('game.make_guess', game_id=game.id) }}">
                        <div id="play-game-form-content">
                            {% for i in range(game.amount_of_positions) %}
                                <div class="nes-select">
                                    <label for="positions_select">Position {{ i + 1 }}</label>
                                    <select required id="positions_select" name="guess">
                                        <option value="" disabled selected hidden>Select...</option>
                                        {% for color in game.colors %}
                                            <option value="{{ color.name }}">{{ color.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            {% endfor %}
                        </div>
                        <div id="play-game-form-submit">
                            <button type="submit" class="nes-btn is-primary" id="guess-btn"
                                    onclick="if (this.form.validate()) { this.disabled = true; this.form.submit(); }">
                                Guess
                            </button>
                        </div>
                    </form>
                    </div>
                    <div class="game-info-box nes-container with-title">
                        <h2 class="title">Game Log</h2>
                        <div id="game-info-message-box">
                            <section class="message-list messages">
                                {% for guess, answer in zip(game.guesses, game.answers) %}
                                    <section class="message -right">
                                        <!-- Balloon -->
                                        <div class="nes-balloon from-right">
                                            <p>{{ guess.guess }}</p>
                                        </div>
                                    </section>
                                    <section class="message -left">
                                        <!-- Balloon -->
                                        <div class="nes-balloon from-left">
                                            <p>Perfect: {{ answer.perfect_guesses }} Good: {{ answer.good_guesses }}
                                                Incorrect: {{ answer.incorrect_guesses }}</p>
                                        </div>
                                    </section>
                                {% endfor %}
                            </section>
                        </div>
                    </div>
                    <div id="game-music-container" class="nes-container">
                        <audio id="game-music-player" controls autoplay></audio>
                    </div>
                    </div>
                    {% if game.cheat_mode %}
                        <div class="nes-container with-title game-box">
                            <p class="title">Cheat menu</p>
                            <p>{{ game.code }}</p>
                        </div>
                    {% endif %}
                {% endif %}
    </div>
    <script>
        const myDiv = document.getElementById("game-info-message-box");
        myDiv.scrollTop = myDiv.scrollHeight;

        const songPaths = [
            "../../static/audio/Africa_8_Bit.mp3",
            "../../static/audio/All_Star_8_Bit.mp3",
            "../../static/audio/Another_One_Bites_The_Dust_8_bit.mp3",
            "../../static/audio/Blue_Da_Ba_Dee_8_Bit.mp3",
            "../../static/audio/Chop_Suey_8_Bit.mp3",
            "../../static/audio/Clint_Eastwood_8_Bit.mp3",
            "../../static/audio/Dont_Stop_Me_Now_8_Bit.mp3",
            "../../static/audio/Harder_Better_Faster_Stronger_8_Bit.mp3",
            "../../static/audio/Never_Gonna_Give_You_Up_8_Bit.mp3",
            "../../static/audio/Radioactive_8_Bit.mp3",
            "../../static/audio/Take_On_Me_8_Bit.mp3",
            "../../static/audio/What_Is_Love.mp3",
            "../../static/audio/Shooting_Stars_8_Bit.mp3",
        ]

        let currentSong = Math.floor(Math.random() * songPaths.length);
        const audioPlayer = document.getElementById("game-music-player");

        function next() {
            if (currentSong === songPaths.length - 1) currentSong = 0;
            else currentSong++;

            audioPlayer.src = songPaths[currentSong];
        }

        if (audioPlayer === null) {
            throw "Audio player does not exist."
        } else {
            audioPlayer.src = songPaths[currentSong];
            audioPlayer.volume = 0.15;

            audioPlayer.addEventListener('ended', next, false);
        }



    </script>
{% endblock %}